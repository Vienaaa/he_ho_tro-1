<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>B∆∞·ªõc 5 - K·∫øt qu·∫£ AHP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --danger-color: #f44336;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 20px;
            background: #f8f9fa;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        h1,
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        h1 {
            font-size: 2.2rem;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 1rem;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .matrix-table th,
        .matrix-table td {
            padding: 12px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .matrix-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
        }

        .result-table th,
        .result-table td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .error-message {
            background-color: #f8d7da;
            color: #842029;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #f5c2c7;
            text-align: center;
        }

        .result-table th {
            background-color: var(--primary-color);
            color: white;
        }

        .rank-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background-color: var(--secondary-color);
            color: white;
            font-weight: 500;
        }

        .action-button {
            /* General style for action buttons */
            background: linear-gradient(to right, var(--primary-color), #45a049);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            margin: 0 0.5rem;
            /* Add some margin between buttons */
        }

        .action-button:hover {
            transform: translateY(-2px);
        }

        .history-btn {
            background: linear-gradient(to right, var(--secondary-color), #1a78c2);
            /* Different color for history */
        }

        .history-btn:hover {
            background: linear-gradient(to right, #1a78c2, #0d47a1);
        }

        .pdf-btn {
            background: linear-gradient(to right, #e04e39, #c73c2a);
            /* Reddish color for PDF */
        }

        .pdf-btn:hover {
            background: linear-gradient(to right, #c73c2a, #a02d1d);
        }

        .section-title {
            color: var(--secondary-color);
            margin: 2rem 0 1rem;
            padding-left: 1rem;
            border-left: 4px solid var(--secondary-color);
        }

        .cr-indicator {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .cr-indicator span {
            display: inline-block;
            margin-left: 1rem;
            font-weight: normal;
            font-size: 1rem;
        }

        .chart-container {
            display: block;
            /* M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã */
            transition: opacity 0.3s ease;
            /* Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªïi m∆∞·ª£t m√† */
            opacity: 1;
        }

        .chart-container.hidden {
            display: none;
            /* ·∫®n container */
            opacity: 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 0 10px;
            }

            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            .action-button {
                width: 100%;
                margin: 0.5rem 0;
                /* Stack buttons on small screens */
            }

            .matrix-table th,
            .matrix-table td {
                padding: 8px;
                /* Smaller padding for tables on small screens */
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>K·∫øt Qu·∫£ Ph√¢n T√≠ch</h1>

        {% if error %}
        <div class="error-message">{{ error }}</div>
        {% else %}
        <div class="cr-indicator">
            <strong>Ch·ªâ s·ªë nh·∫•t qu√°n CR:</strong> {{ criteria_cr | round(4) }}
            {% if criteria_cr > 0.1 %}
            <span style="color: var(--danger-color);">(C·∫¢NH B√ÅO: CR > 0.1 - C·∫ßn ki·ªÉm tra l·∫°i c√°c so s√°nh)</span>
            {% else %}
            <span style="color: var(--primary-color);">(ƒê·∫°t y√™u c·∫ßu nh·∫•t qu√°n)</span>
            {% endif %}
            <br />
            <strong>Ch·ªâ s·ªë nh·∫•t qu√°n CI:</strong>
            {% if criteria_ci is not none %}
            {{ criteria_ci }}
            {% else %}
            Kh√¥ng x√°c ƒë·ªãnh
            {% endif %}


            <br />
            <strong>Lambda max (Œª_max):</strong> {{ lambda_max | round(4) }}
            <br />
            <small style="font-style: italic; color: #555;">
                (Œª_max l√† gi√° tr·ªã ri√™ng l·ªõn nh·∫•t c·ªßa ma tr·∫≠n so s√°nh c·∫∑p ti√™u ch√≠)
            </small>
        </div>

        <h2 class="section-title">Tr·ªçng S·ªë C√°c Ti√™u Ch√≠</h2>
        <table class="result-table">
            <thead>
                <tr>
                    <th>Ti√™u ch√≠</th>
                    <th>Tr·ªçng s·ªë</th>
                    <th>Ma tr·∫≠n so s√°nh</th>
                </tr>
            </thead>
            <tbody>
                {% for criterion, weight in zip(criteria, criteria_weights) %}
                <tr>
                    <td>{{ criterion }}</td>
                    <td>{{ weight | round(4) }}</td>
                    <td>
                        <details>
                            <summary>Xem ma tr·∫≠n</summary>
                            <table class="matrix-table">
                                {% for row in pairwise_matrices[criterion] %}
                                <tr>
                                    {% for val in row %}
                                    <td>{{ val | round(3) }}</td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </table>
                        </details>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2 class="section-title">X·∫øp H·∫°ng Ph∆∞∆°ng √Ån</h2>
        <table class="result-table">
            <thead>
                <tr>
                    <th>X·∫øp h·∫°ng</th>
                    <th>Ph∆∞∆°ng √°n</th>
                    <th>ƒêi·ªÉm t·ªïng h·ª£p</th>
                    <th>Chi ti·∫øt theo ti√™u ch√≠</th>
                </tr>
            </thead>
            <tbody>
                {% for row in df_results %}
                <tr>
                    <td><span class="rank-badge">#{{ row['X·∫øp h·∫°ng'] }}</span></td>
                    <td>{{ row['Ph∆∞∆°ng √°n'] }}</td>
                    <td>{{ row['ƒêi·ªÉm t·ªïng h·ª£p'] | round(4) }}</td>
                    <td>
                        <ul style="text-align: left; margin: 0; padding-left: 1.5rem;">
                            {% for criterion in criteria %}
                            <li>{{ criterion }}: {{ row[criterion] | round(4) }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="text-align: center; margin-top: 2rem;">
            <!-- Bi·ªÉu ƒë·ªì tr·ªçng s·ªë ti√™u ch√≠ -->
            <h2 class="section-title">Bi·ªÉu ƒê·ªì Tr·ªçng S·ªë Ti√™u Ch√≠</h2>
            <div id="pieChartContainer" class="chart-container">
                {% if plot_criteria_weights_base64 %}
                <img loading="lazy" src="{{ plot_criteria_weights_base64 }}" alt="Bi·ªÉu ƒë·ªì tr√≤n tr·ªçng s·ªë ti√™u ch√≠"
                    style="max-width: 100%; height: auto;">
                {% else %}
                <p>Kh√¥ng c√≥ d·ªØ li·ªáu bi·ªÉu ƒë·ªì tr·ªçng s·ªë ti√™u ch√≠.</p>
                {% endif %}
            </div>
            <button id="togglePieChartBtn" class="action-button chart-btn">üìä Hi·ªÉn th·ªã/·∫®n Bi·ªÉu ƒê·ªì Tr·ªçng S·ªë Ti√™u
                Ch√≠</button>

            <!-- Bi·ªÉu ƒë·ªì ƒëi·ªÉm t·ªïng h·ª£p ph∆∞∆°ng √°n -->
            <h2 class="section-title">Bi·ªÉu ƒê·ªì ƒêi·ªÉm T·ªïng H·ª£p Ph∆∞∆°ng √Ån</h2>
            <div id="optionPieChartContainer" class="chart-container">
                {% if plot_option_scores_base64 %}
                <img loading="lazy" src="{{ plot_option_scores_base64 }}" alt="Bi·ªÉu ƒë·ªì tr√≤n ƒëi·ªÉm t·ªïng h·ª£p ph∆∞∆°ng √°n"
                    style="max-width: 100%; height: auto;">
                {% else %}
                <p>Kh√¥ng c√≥ d·ªØ li·ªáu bi·ªÉu ƒë·ªì ƒëi·ªÉm t·ªïng h·ª£p ph∆∞∆°ng √°n.</p>
                {% endif %}
            </div>
            <button id="toggleOptionPieChartBtn" class="action-button chart-btn">üìä Hi·ªÉn th·ªã/·∫®n Bi·ªÉu ƒê·ªì ƒêi·ªÉm T·ªïng
                H·ª£p</button>

            <!-- C√°c n√∫t t·∫£i, xu·∫•t b√°o c√°o -->
            <form method="post" style="display: inline-block;">
                <button type="submit" name="download" value="1" class="action-button">
                    ‚¨áÔ∏è T·∫£i B√°o C√°o ƒê·∫ßy ƒê·ªß (Excel)
                </button>
            </form>
            <button id="downloadPdfBtn" class="action-button pdf-btn">
                üìÑ Xu·∫•t B√°o C√°o (PDF)
            </button>
            <a href="{{ url_for('history') }}" class="action-button history-btn">
                üìú Xem L·ªãch S·ª≠
            </a>
        </div>

        <!-- {% endif %} -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // H√†m chung ƒë·ªÉ x·ª≠ l√Ω ·∫©n/hi·ªán bi·ªÉu ƒë·ªì
            function toggleChart(containerId, buttonId, showText, hideText) {
                const container = document.getElementById(containerId);
                const button = document.getElementById(buttonId);
                if (!container || !button) return; // Ki·ªÉm tra t·ªìn t·∫°i

                container.classList.toggle('hidden');
                // C·∫≠p nh·∫≠t text c·ªßa n√∫t d·ª±a tr√™n tr·∫°ng th√°i
                const isHidden = container.classList.contains('hidden');
                button.textContent = isHidden ? showText : hideText;

                // L∆∞u tr·∫°ng th√°i hi·ªÉn th·ªã/·∫©n v√†o localStorage
                localStorage.setItem(containerId + '_hidden', isHidden);
            }

            // Kh√¥i ph·ª•c tr·∫°ng th√°i hi·ªÉn th·ªã/·∫©n t·ª´ localStorage khi t·∫£i trang
            function restoreChartState(containerId, buttonId, showText, hideText) {
                const container = document.getElementById(containerId);
                const button = document.getElementById(buttonId);
                if (!container || !button) return;

                const isHidden = localStorage.getItem(containerId + '_hidden') === 'true';
                if (isHidden) {
                    container.classList.add('hidden');
                    button.textContent = showText;
                } else {
                    container.classList.remove('hidden');
                    button.textContent = hideText;
                }
            }

            // X·ª≠ l√Ω n√∫t cho bi·ªÉu ƒë·ªì tr·ªçng s·ªë ti√™u ch√≠
            const togglePieChartBtn = document.getElementById('togglePieChartBtn');
            if (togglePieChartBtn) {
                togglePieChartBtn.addEventListener('click', function () {
                    toggleChart(
                        'pieChartContainer',
                        'togglePieChartBtn',
                        'üìä Hi·ªÉn th·ªã Bi·ªÉu ƒê·ªì Tr·ªçng S·ªë Ti√™u Ch√≠',
                        'üìä ·∫®n Bi·ªÉu ƒê·ªì Tr·ªçng S·ªë Ti√™u Ch√≠'
                    );
                });
                // Kh√¥i ph·ª•c tr·∫°ng th√°i
                restoreChartState(
                    'pieChartContainer',
                    'togglePieChartBtn',
                    'üìä Hi·ªÉn th·ªã Bi·ªÉu ƒê·ªì Tr·ªçng S·ªë Ti√™u Ch√≠',
                    'üìä ·∫®n Bi·ªÉu ƒê·ªì Tr·ªçng S·ªë Ti√™u Ch√≠'
                );
            }

            // X·ª≠ l√Ω n√∫t cho bi·ªÉu ƒë·ªì ƒëi·ªÉm t·ªïng h·ª£p ph∆∞∆°ng √°n
            const toggleOptionPieChartBtn = document.getElementById('toggleOptionPieChartBtn');
            if (toggleOptionPieChartBtn) {
                toggleOptionPieChartBtn.addEventListener('click', function () {
                    toggleChart(
                        'optionPieChartContainer',
                        'toggleOptionPieChartBtn',
                        'üìä Hi·ªÉn th·ªã Bi·ªÉu ƒê·ªì ƒêi·ªÉm T·ªïng H·ª£p',
                        'üìä ·∫®n Bi·ªÉu ƒê·ªì ƒêi·ªÉm T·ªïng H·ª£p'
                    );
                });
                // Kh√¥i ph·ª•c tr·∫°ng th√°i
                restoreChartState(
                    'optionPieChartContainer',
                    'toggleOptionPieChartBtn',
                    'üìä Hi·ªÉn th·ªã Bi·ªÉu ƒê·ªì ƒêi·ªÉm T·ªïng H·ª£p',
                    'üìä ·∫®n Bi·ªÉu ƒê·ªì ƒêi·ªÉm T·ªïng H·ª£p'
                );
            }

            // X·ª≠ l√Ω n√∫t xu·∫•t PDF
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');

            function waitForImagesToLoad(container, callback) {
                const images = container.querySelectorAll('img');
                let loadedCount = 0;

                if (images.length === 0) {
                    callback();
                    return;
                }

                images.forEach(img => {
                    if (img.complete) {
                        loadedCount++;
                        if (loadedCount === images.length) {
                            callback();
                        }
                    } else {
                        img.onload = img.onerror = () => {
                            loadedCount++;
                            if (loadedCount === images.length) {
                                callback();
                            }
                        };
                    }
                });
            }

            if (downloadPdfBtn) {
                downloadPdfBtn.addEventListener('click', function () {
                    // Hi·ªán l·∫°i c√°c bi·ªÉu ƒë·ªì b·ªã ·∫©n n·∫øu c√≥
                    const pieChartContainer = document.getElementById('pieChartContainer');
                    const optionPieChartContainer = document.getElementById('optionPieChartContainer');

                    if (pieChartContainer) {
                        pieChartContainer.classList.remove('hidden');
                        document.getElementById('togglePieChartBtn').textContent = 'üìä ·∫®n Bi·ªÉu ƒê·ªì Tr·ªçng S·ªë Ti√™u Ch√≠';
                        localStorage.setItem('pieChartContainer_hidden', 'false');
                    }
                    if (optionPieChartContainer) {
                        optionPieChartContainer.classList.remove('hidden');
                        document.getElementById('toggleOptionPieChartBtn').textContent = 'üìä ·∫®n Bi·ªÉu ƒê·ªì ƒêi·ªÉm T·ªïng H·ª£p';
                        localStorage.setItem('optionPieChartContainer_hidden', 'false');
                    }

                    // L·∫•y ph·∫ßn t·ª≠ to√†n trang c·∫ßn xu·∫•t PDF
                    const element = document.body;

                    // T√πy ch·ªçn xu·∫•t PDF
                    const opt = {
                        margin: 0.5,
                        filename: 'Ket_qua_AHP.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: {
                            scale: 2.5,            // tƒÉng ƒë·ªô n√©t
                            logging: true,
                            useCORS: true
                        },
                        jsPDF: {
                            unit: 'in',
                            format: 'a4',
                            orientation: 'portrait'
                        }
                    };

                    // Cu·ªôn l√™n ƒë·∫ßu trang ƒë·ªÉ html2pdf render t·ª´ ƒë·∫ßu
                    window.scrollTo(0, 0);

                    // ƒê·ª£i ·∫£nh t·∫£i xong r·ªìi m·ªõi xu·∫•t PDF
                    waitForImagesToLoad(element, () => {
                        html2pdf().set(opt).from(element).save().then(() => {
                            alert('B√°o c√°o ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng d∆∞·ªõi d·∫°ng PDF!');
                        }).catch(err => {
                            console.error('L·ªói khi xu·∫•t PDF:', err);
                            alert('ƒê√£ x·∫£y ra l·ªói khi xu·∫•t PDF. Vui l√≤ng th·ª≠ l·∫°i.');
                        });
                    });
                });
            }


            // X·ª≠ l√Ω n√∫t l√†m m·ªõi trang
            const refreshBtn = document.createElement('button');
            refreshBtn.textContent = 'üîÑ L√†m M·ªõi Trang';
            refreshBtn.className = 'action-button refresh-btn';
            refreshBtn.style.background = 'linear-gradient(to right, #ff9800, #f57c00)';
            refreshBtn.style.margin = '0.5rem';
            refreshBtn.addEventListener('click', function () {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën l√†m m·ªõi trang? C√°c bi·ªÉu ƒë·ªì s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã l·∫°i.')) {
                    localStorage.removeItem('pieChartContainer_hidden');
                    localStorage.removeItem('optionPieChartContainer_hidden');
                    window.location.reload();
                }
            });

            // Th√™m n√∫t l√†m m·ªõi v√†o khu v·ª±c action buttons
            const actionButtonArea = document.querySelector('.container div[style*="text-align: center"]');
            if (actionButtonArea) {
                actionButtonArea.appendChild(refreshBtn);
            }
        });
    </script>
</body>

</html>